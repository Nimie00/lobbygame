<ion-content>
  <ion-modal #createLobbyModal>
    <ng-template>
      <h2>Create a Lobby</h2>
      <ion-item class="custom-item">
        <ion-label position="stacked">Choose a game</ion-label>
        <ion-select id="gameType" [(ngModel)]="selectedGame" class="custom-input" required>
          <ion-select-option *ngFor="let game of games$ | async" [value]="game">
            {{ game.name }}
          </ion-select-option>
        </ion-select>
      </ion-item>
      <ion-item class="custom-item">
        <ion-label position="stacked">Lobby Name</ion-label>
        <ion-input [(ngModel)]="lobbyName" placeholder="Enter lobby name" class="custom-input" required="true"></ion-input>
      </ion-item>
      <ion-item class="custom-item">
        <ion-label position="stacked">Number of rounds to play</ion-label>
        <ion-input [(ngModel)]="maxRounds" type="number" max="10" min="1" value="1" class="custom-input" required="true"></ion-input>
      </ion-item>
      <!-- TODO: ADD MINIMAL and MAXIMAL number of players that can join a lobby and for starting the game, max should be set by gametype, and min also-->
      <ion-item class="custom-item">
        <ion-label>Allow spectators to join</ion-label>
        <ion-checkbox [(ngModel)]="allowSpectators" class="custom-input"></ion-checkbox>
        <ion-label>Make the lobby private</ion-label>
        <ion-checkbox [(ngModel)]="private" class="custom-input"></ion-checkbox>
        <ion-label>Enable password for the lobby</ion-label>
        <ion-checkbox [(ngModel)]="enablePassword" class="custom-input"></ion-checkbox>
        <ion-label>Change the minimal and maximal number of players</ion-label>
        <ion-checkbox [(ngModel)]="enablePlayerNumbers" class="custom-input"></ion-checkbox>
      </ion-item>
      <ion-item class="custom-item" *ngIf="enablePassword === true">
        <ion-label position="stacked">Set your password for the lobby</ion-label>
        <ion-input [(ngModel)]="password" placeholder="Type your password here" class="custom-input"></ion-input>
      </ion-item>
      <ion-item class="custom-item" *ngIf="enablePlayerNumbers === true">
        <ion-label position="stacked">Set the minimal number of players for the game (at least 2 players)</ion-label>
        <ion-input [(ngModel)]="minPlayers" type="number" max="8" min="2" value="2" class="custom-input"></ion-input>
        <ion-label position="stacked">Set the maximal number of players for the game (Capped for each game)</ion-label>
        <ion-input [(ngModel)]="maxPlayers" type="number" max="8" min="2" value="4" class="custom-input"></ion-input>
      </ion-item>

      <ion-button (click)="createLobby()" class="custom-button"> Create Lobby</ion-button>
    </ng-template>
  </ion-modal>
  <ion-card class="container">
    <ion-card-header>
      <ion-button expand="block" class="create-lobby-button" (click)="toggleCreateLobby()"
                  [disabled]=" hasLobby || joinedLobby!=null">
        Create New Lobby
      </ion-button>
      <h2>Available Lobbies</h2>
    </ion-card-header>
    <ion-card-content>
      <ion-button (click)="openTagModal()">Search Tags</ion-button>
      <ion-modal #tagModal>
        <ng-template>
          <ion-header>
            <ion-toolbar>
              <ion-title>Set Search Tags</ion-title>
              <ion-buttons slot="end">
                <ion-button (click)="dismissTagModal()">Close</ion-button>
              </ion-buttons>
            </ion-toolbar>
          </ion-header>
          <ion-content>
          </ion-content>
        </ng-template>
      </ion-modal>
      <ion-searchbar [(ngModel)]="searchTerm" (ionInput)="filterLobbies(this.userId)"></ion-searchbar>
      <ion-list class="lobby-list">
        <ion-item *ngFor="let lobby of (lobbies | async)"
                  [ngClass]="{ 'owner-lobby': isOwner(lobby), 'started-lobby': lobby.status === 'started' }">
          <ion-card class="lobby-item"
                    [style.background-color]="getLobbyBackgroundColor(lobby)">
            <ion-card-content>
              <h3>{{ lobby.name }}</h3>
              <p>Game: {{ lobby.gameType }}</p>
              <p>Owner: {{ lobby.owner }}</p>
              <p>Players: {{ lobby.players.length }}</p>
              <p>spectators: {{ lobby.spectators.length }}</p>
              <div *ngIf="isOwner(lobby)">
                <ion-button class="startbutton" (click)="startGame(lobby.id)" *ngIf="lobby.status !== 'started'  && lobby.private !== 'true'">Start
                  Game
                </ion-button>
                <ion-button class="destroybutton" (click)="destroyLobby(lobby.id)">Delete Lobby</ion-button>
                <ion-button class="botbutton" (click)="addBot(lobby.id)" [disabled]="true">Add Bot</ion-button>
                <ion-button class="kickbutton" (click)="kickUser(lobby.id)" [disabled]="true">Kick & Ban User
                </ion-button>
              </div>
              <div *ngIf="!isOwner(lobby) && lobby.status !== 'started'  && lobby.private !== 'true'">
                <ion-button class="joinbutton" *ngIf="!isUserInLobby(lobby)" (click)="joinLobby(lobby.id)"
                            [disabled]="hasLobby || joinedLobby!==null">Join
                </ion-button>
                <ion-button class="spectatebutton" *ngIf="!isUserInLobby(lobby)" (click)="joinAsSpectator(lobby.id)"
                            [disabled]="hasLobby || joinedLobby!==null">Join as Spectator
                </ion-button>
                <ion-button class="leavebutton" *ngIf="isUserInLobby(lobby)" (click)="leaveLobby(lobby.id)">Leave
                </ion-button>
                <ion-button class="stopspectatebutton" *ngIf="isUserSpectatingLobby(lobby)"
                            (click)="leaveAsSpectator(lobby.id)">Stop spectating
                </ion-button>
              </div>

              <div *ngIf="!isOwner(lobby) && lobby.private === 'true'">
                <ion-button class="joinbutton" *ngIf="!isUserInLobby(lobby)" (click)="joinLobby(lobby.id)"
                            [disabled]="hasLobby || joinedLobby!==null">Join with password
                </ion-button>
<!--                <ion-button class="spectatebutton" *ngIf="!isUserInLobby(lobby)" (click)="joinAsSpectator(lobby.id)"-->
<!--                            [disabled]="hasLobby || joinedlobby!==null">Join as Spectator-->
<!--                </ion-button>-->
                <ion-button class="leavebutton" *ngIf="isUserInLobby(lobby)" (click)="leaveLobby(lobby.id)">Leave
                </ion-button>
                <ion-button class="stopspectatebutton" *ngIf="isUserSpectatingLobby(lobby)"
                            (click)="leaveAsSpectator(lobby.id)">Stop spectating
                </ion-button>
              </div>

              <div *ngIf="lobby.status === 'started' && !isUserInLobby(lobby)">
                <ion-button class="spectatebutton" (click)="joinAsSpectator(lobby.id)"
                            [disabled]="hasLobby || joinedLobby!==null">Join as Spectator
                </ion-button>
                <ion-button class="stopspectatebutton" *ngIf="isUserSpectatingLobby(lobby)"
                            (click)="leaveAsSpectator(lobby.id)">Stop spectating
                </ion-button>
              </div>

              <div *ngIf="lobby.status === 'started' && (isUserInLobby(lobby) || isUserSpectatingLobby(lobby))">
                <ion-button class="jumptogame" (click)="jumptogame(lobby.id)">Jump to game window</ion-button>
              </div>

            </ion-card-content>
          </ion-card>
        </ion-item>
      </ion-list>
    </ion-card-content>
  </ion-card>
</ion-content>
